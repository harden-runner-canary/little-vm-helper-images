# syntax=docker/dockerfile:1.3-labs
# vim: set ft=dockerfile:

FROM quay.io/lvh-images/lvh:v0.0.19 AS lvh

FROM rockylinux:8 AS builder

COPY --from=lvh /usr/bin/lvh /usr/bin/lvh

RUN dnf install -y 'dnf-command(builddep)' 'dnf-command(config-manager)'
RUN dnf config-manager --set-enabled powertools

FROM builder AS prepare

WORKDIR /tmp

# from: https://github.com/bottlerocket-os/bottlerocket-kernel-kit/blob/develop/packages/kernel-6.1/kernel-6.1.spec#L1
RUN curl -LO "https://cdn.amazonlinux.com/al2023/blobstore/bc929cd6c35e297ebc5760d75997d219080501a32b7936641003178bce778074/kernel-6.1.102-111.182.amzn2023.src.rpm"

RUN rpm -ivh kernel*.src.rpm

WORKDIR /root/rpmbuild/SPECS
RUN dnf builddep -y --define '_with_baseonly 1' kernel.spec
RUN rpmbuild -bp kernel.spec --with baseonly

RUN ln -s /root/rpmbuild/BUILD/kernel-*/linux-* /tmp/build
WORKDIR /tmp/build

# Emulate InitBuildVars() from kernel.spec
RUN make -s mrproper
RUN cp configs/kernel-*-$(uname -m).config .config

COPY _data /data

RUN lvh kernels --dir /data raw_configure . bottlerocket61102 2>&1

FROM prepare AS build

RUN make -j $(nproc) tar-pkg

COPY scripts/generate-btf.sh /tmp/
RUN /tmp/generate-btf.sh /tmp/build/tar-install

FROM busybox as kernel
COPY --from=build /tmp/build/tar-install /data/kernels/bottlerocket61102
